{% extends 'base/base.html' %}
{% load static %}

{% block title %}لوحة التحكم - بوابة الطلاب{% endblock %}

{% block extra_css %}
<style>
    .stats-card {
        background: linear-gradient(135deg, #102A71 0%, #1a3a8a 100%);
    }
    .stats-card-2 {
        background: linear-gradient(135deg, #F5C400 0%, #e6b000 100%);
    }
    .stats-card-3 {
        background: linear-gradient(135deg, #102A71 0%, #0d2159 100%);
    }
    .stats-card-4 {
        background: linear-gradient(135deg, #F5C400 0%, #d4a700 100%);
    }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 py-8" x-data="studentDashboard()">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Welcome Header -->
        <div class="mb-8">
            <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        {% if user.profile_picture %}
                            <img src="{{ user.profile_picture.url }}" alt="Profile" class="h-16 w-16 rounded-full object-cover border-4" style="border-color: rgba(245, 196, 0, 0.3);">
                        {% else %}
                            <div class="h-16 w-16 rounded-full flex items-center justify-center" style="background: linear-gradient(135deg, #102A71 0%, #1a3a8a 100%);">
                                <i class="fas fa-user text-white text-xl"></i>
                            </div>
                        {% endif %}
                        <div>
                            <h1 class="text-2xl font-bold text-gray-900">
                                مرحباً بعودتك، {{ user.first_name|default:user.username }}!
                            </h1>
                            <p class="text-gray-600">
                                رقم الطالب: {{ user.university_id }} | {{ user.major|default:"البرنامج غير محدد" }}
                            </p>
                            <p class="text-sm text-gray-500">
                                آخر دخول: {{ user.last_login|date:"M d, Y \a\t H:i" }}
                            </p>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-sm text-gray-500 mb-1">الفصل الحالي</div>
                        <div class="text-lg font-semibold text-gray-900">خريف 2024</div>
                        <a href="{% url 'accounts:digital_id' %}" class="inline-flex items-center mt-2 px-4 py-2 text-white text-sm font-medium rounded-lg transition-colors" style="background-color: #102A71; hover:background-color: #0d2159;">
                            <i class="fas fa-id-card ml-2"></i>
                            عرض الهوية الرقمية
                        </a>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Quick Stats -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- Pending Requests -->
            <div class="stats-card rounded-xl p-6 text-white card-hover">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-white text-sm font-medium opacity-90">الطلبات المعلقة</p>
                        <p class="text-3xl font-bold text-white" x-text="stats.pending_requests">0</p>
                    </div>
                    <div class="bg-white bg-opacity-20 rounded-full p-3">
                        <i class="fas fa-clock text-2xl"></i>
                    </div>
                </div>
                <div class="mt-4">
                    <a href="{% url 'student_portal:eservices_center' %}" class="text-white hover:text-yellow-200 text-sm font-medium opacity-90">
                        View all requests →
                    </a>
                </div>
            </div>
            
            <!-- Outstanding Fees -->
            <div class="stats-card-2 rounded-xl p-6 text-white card-hover">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-pink-100 text-sm font-medium">الرسوم المستحقة</p>
                        <p class="text-3xl font-bold">$<span x-text="stats.outstanding_fees">{{ outstanding_fees|default:"0" }}</span></p>
                    </div>
                    <div class="bg-white bg-opacity-20 rounded-full p-3">
                        <i class="fas fa-dollar-sign text-2xl"></i>
                    </div>
                </div>
                <div class="mt-4">
                    <a href="{% url 'financial:dashboard' %}" class="text-pink-100 hover:text-white text-sm font-medium">
                        Pay now →
                    </a>
                </div>
            </div>
            
            <!-- New Documents -->
            <div class="stats-card-3 rounded-xl p-6 text-white card-hover">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-white text-sm font-medium opacity-90">المستندات الجديدة</p>
                        <p class="text-3xl font-bold text-white" x-text="stats.new_documents">0</p>
                    </div>
                    <div class="bg-white bg-opacity-20 rounded-full p-3">
                        <i class="fas fa-file-alt text-2xl"></i>
                    </div>
                </div>
                <div class="mt-4">
                    <a href="{% url 'student_portal:documents' %}" class="text-white hover:text-yellow-200 text-sm font-medium opacity-90">
                        View documents →
                    </a>
                </div>
            </div>
            
            <!-- Unread Notifications -->
            <div class="stats-card-4 rounded-xl p-6 text-white card-hover">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-white text-sm font-medium opacity-90">الإشعارات</p>
                        <p class="text-3xl font-bold text-white" x-text="stats.unread_notifications">0</p>
                    </div>
                    <div class="bg-white bg-opacity-20 rounded-full p-3">
                        <i class="fas fa-bell text-2xl"></i>
                    </div>
                </div>
                <div class="mt-4">
                    <a href="{% url 'notifications:notification_center' %}" class="text-white hover:text-yellow-200 text-sm font-medium opacity-90">
                        View all →
                    </a>
                </div>
            </div>
        </div>
        
        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Left Column -->
            <div class="lg:col-span-2 space-y-8">
                <!-- Quick Actions -->
                <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
                    <h2 class="text-xl font-semibold text-gray-900 mb-6">
                        <i class="fas fa-bolt ml-2" style="color: #102A71;"></i>
                        الإجراءات السريعة
                    </h2>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <a href="{% url 'student_portal:create_request' %}" class="group flex flex-col items-center p-4 rounded-lg transition-colors" style="background-color: rgba(16, 42, 113, 0.1); hover:background-color: rgba(16, 42, 113, 0.2);">
                            <div class="text-white rounded-full p-3 mb-3 transition-colors" style="background-color: #102A71; group-hover:background-color: #0d2159;">
                                <i class="fas fa-plus text-lg"></i>
                            </div>
                            <span class="text-sm font-medium text-gray-700 text-center">طلب جديد</span>
                        </a>
                        
                        <a href="{% url 'financial:pay_fees' %}" class="group flex flex-col items-center p-4 rounded-lg transition-colors bg-yellow-50 hover:bg-yellow-100">
                            <div class="text-white rounded-full p-3 mb-3 transition-colors" style="background-color: #F5C400; group-hover:background-color: #e6b000;">
                                <i class="fas fa-credit-card text-lg"></i>
                            </div>
                            <span class="text-sm font-medium text-gray-700 text-center">دفع الرسوم</span>
                        </a>
                        
                        <a href="{% url 'student_portal:support' %}" class="group flex flex-col items-center p-4 rounded-lg transition-colors" style="background-color: rgba(16, 42, 113, 0.1); hover:background-color: rgba(16, 42, 113, 0.2);">
                            <div class="text-white rounded-full p-3 mb-3 transition-colors" style="background-color: #102A71; group-hover:background-color: #0d2159;">
                                <i class="fas fa-headset text-lg"></i>
                            </div>
                            <span class="text-sm font-medium text-gray-700 text-center">الحصول على الدعم</span>
                        </a>
                        
                        <a href="{% url 'accounts:profile' %}" class="group flex flex-col items-center p-4 rounded-lg transition-colors" style="background-color: rgba(245, 196, 0, 0.1); hover:background-color: rgba(245, 196, 0, 0.2);">
                            <div class="text-white rounded-full p-3 mb-3 transition-colors" style="background-color: #F5C400; group-hover:background-color: #e6b000;">
                                <i class="fas fa-user-edit text-lg"></i>
                            </div>
                            <span class="text-sm font-medium text-gray-700 text-center">تعديل الملف الشخصي</span>
                        </a>
                    </div>
                </div>
                
                <!-- Recent Requests -->
                <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-xl font-semibold text-gray-900">
                            <i class="fas fa-clipboard-list ml-2" style="color: #102A71;"></i>
                            الطلبات الحديثة
                        </h2>
                        <a href="{% url 'student_portal:eservices_center' %}" class="text-sm font-medium hover:underline" style="color: #102A71; hover:color: #F5C400;">
                                عرض جميع الطلبات
                            </a>
                    </div>
                    
                    <div class="space-y-4" x-show="!loadingRequests">
                        <template x-for="request in recentRequests" :key="request.id">
                            <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                                <div class="flex items-center space-x-4">
                                    <div class="flex-shrink-0">
                                        <div class="w-10 h-10 rounded-full flex items-center justify-center" style="background-color: rgba(16, 42, 113, 0.1);">
                                            <i class="fas fa-file-alt" style="color: #102A71;"></i>
                                        </div>
                                    </div>
                                    <div>
                                        <h3 class="text-sm font-medium text-gray-900" x-text="request.request_type"></h3>
                                        <p class="text-sm text-gray-500" x-text="request.created_at"></p>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-3">
                                    <span class="px-2 py-1 text-xs font-medium rounded-full" 
                                          :class="{
                                              'text-white': request.status === 'pending',
                                              'text-white': request.status === 'in_review',
                                              'text-white': request.status === 'approved',
                                              'bg-red-100 text-red-800': request.status === 'rejected'
                                          }"
                                          :style="{
                                              'background-color': request.status === 'pending' ? '#F5C400' : request.status === 'in_review' ? '#102A71' : request.status === 'approved' ? '#102A71' : ''
                                          }"
                                          x-text="request.status"></span>
                                    <a :href="'/student-portal/requests/' + request.id + '/'" class="hover:underline" style="color: #102A71; hover:color: #F5C400;">
                                        <i class="fas fa-arrow-right"></i>
                                    </a>
                                </div>
                            </div>
                        </template>
                        
                        <div x-show="recentRequests.length === 0" class="text-center py-8 text-gray-500">
                            <i class="fas fa-inbox text-3xl mb-3"></i>
                            <p>لا توجد طلبات حديثة</p>
                            <a href="{% url 'student_portal:create_request' %}" class="text-sm font-medium mt-2 inline-block hover:underline" style="color: #102A71; hover:color: #F5C400;">
                                إنشاء طلبك الأول
                            </a>
                        </div>
                    </div>
                    
                    <div x-show="loadingRequests" class="text-center py-8">
                        <div class="spinner mx-auto mb-3"></div>
                        <p class="text-gray-500">جاري تحميل الطلبات...</p>
                    </div>
                </div>
            </div>
            
            <!-- Right Column -->
            <div class="space-y-8">
                <!-- Upcoming Deadlines -->
                <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
                    <h2 class="text-xl font-semibold text-gray-900 mb-6">
                        <i class="fas fa-calendar-alt text-red-600 ml-2"></i>
                        المواعيد النهائية القادمة
                    </h2>
                    
                    <div class="space-y-4">
                        <div class="flex items-center space-x-3 p-3 bg-red-50 rounded-lg">
                            <div class="flex-shrink-0">
                                <div class="w-8 h-8 bg-red-100 rounded-full flex items-center justify-center">
                                    <i class="fas fa-exclamation text-red-600 text-sm"></i>
                                </div>
                            </div>
                            <div class="flex-1">
                                <p class="text-sm font-medium text-gray-900">دفع الرسوم الدراسية</p>
                                <p class="text-xs text-red-600">مستحق خلال 3 أيام</p>
                            </div>
                        </div>
                        
                        <div class="flex items-center space-x-3 p-3 bg-yellow-50 rounded-lg">
                            <div class="flex-shrink-0">
                                <div class="w-8 h-8 bg-yellow-100 rounded-full flex items-center justify-center">
                                    <i class="fas fa-clock text-yellow-600 text-sm"></i>
                                </div>
                            </div>
                            <div class="flex-1">
                                <p class="text-sm font-medium text-gray-900">تسجيل المقررات</p>
                                <p class="text-xs text-yellow-600">مستحق خلال أسبوع</p>
                            </div>
                        </div>
                        
                        <div class="flex items-center space-x-3 p-3 rounded-lg" style="background-color: rgba(16, 42, 113, 0.1);">
                            <div class="flex-shrink-0">
                                <div class="w-8 h-8 rounded-full flex items-center justify-center" style="background-color: rgba(16, 42, 113, 0.2);">
                                    <i class="fas fa-info text-sm" style="color: #102A71;"></i>
                                </div>
                            </div>
                            <div class="flex-1">
                                <p class="text-sm font-medium text-gray-900">طلب المنحة الدراسية</p>
                                <p class="text-xs" style="color: #102A71;">مستحق خلال أسبوعين</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Recent Announcements -->
                <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-xl font-semibold text-gray-900">
                            <i class="fas fa-bullhorn text-green-600 ml-2"></i>
                            الإعلانات
                        </h2>
                        <a href="{% url 'notifications:announcements' %}" class="text-sm font-medium hover:underline" style="color: #102A71; hover:color: #F5C400;">
                            عرض الكل
                        </a>
                    </div>
                    
                    <div class="space-y-4" x-show="!loadingAnnouncements">
                        <template x-for="announcement in recentAnnouncements" :key="announcement.id">
                            <div class="border-l-4 pl-4 py-2" style="border-left-color: #102A71;">
                                <h3 class="text-sm font-medium text-gray-900" x-text="announcement.title"></h3>
                                <p class="text-xs text-gray-500 mt-1" x-text="announcement.created_at"></p>
                                <p class="text-sm text-gray-600 mt-2" x-text="announcement.excerpt"></p>
                            </div>
                        </template>
                        
                        <div x-show="recentAnnouncements.length === 0" class="text-center py-4 text-gray-500">
                            <i class="fas fa-bullhorn text-2xl mb-2"></i>
                            <p class="text-sm">لا توجد إعلانات حديثة</p>
                        </div>
                    </div>
                    
                    <div x-show="loadingAnnouncements" class="text-center py-4">
                        <div class="spinner mx-auto mb-2"></div>
                        <p class="text-gray-500 text-sm">جاري تحميل الإعلانات...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function studentDashboard() {
        return {
            stats: {
                pending_requests: 0,
                outstanding_fees: 0,
                new_documents: 0,
                unread_notifications: 0
            },
            recentRequests: [],
            recentAnnouncements: [],
            loadingRequests: true,
            loadingAnnouncements: true,
            
            async init() {
                await this.loadDashboardData();
            },
            
            async loadDashboardData() {
                try {
                    // Load stats
                    const statsResponse = await fetch('/student/ajax/dashboard-stats/');
                    if (statsResponse.ok) {
                        const statsData = await statsResponse.json();
                        this.stats = { ...this.stats, ...statsData };
                    }
                    
                    // Load recent requests
                    const requestsResponse = await fetch('/student/ajax/recent-requests/');
                    if (requestsResponse.ok) {
                        const requestsData = await requestsResponse.json();
                        this.recentRequests = requestsData.requests || [];
                    }
                    this.loadingRequests = false;
                    
                    // Load recent announcements
                    const announcementsResponse = await fetch('/notifications/ajax/recent-notifications/');
                    if (announcementsResponse.ok) {
                        const announcementsData = await announcementsResponse.json();
                        this.recentAnnouncements = announcementsData.announcements || [];
                    }
                    this.loadingAnnouncements = false;
                    
                } catch (error) {
                    console.error('Failed to load dashboard data:', error);
                    this.loadingRequests = false;
                    this.loadingAnnouncements = false;
                }
            }
        }
    }
</script>
{% endblock %}