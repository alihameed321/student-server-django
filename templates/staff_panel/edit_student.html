{% extends 'base/base.html' %}
{% load static %}

{% block title %}Edit Student - {{ student.get_full_name }} - Staff Panel{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 py-8">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Header -->
        <div class="mb-8">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <a href="{% url 'staff_panel:student_detail' student.id %}" 
                       class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-arrow-left text-xl"></i>
                    </a>
                    <div>
                        <h1 class="text-3xl font-bold text-gray-900">Edit Student</h1>
                        <p class="mt-2 text-gray-600">Update information for {{ student.get_full_name }}</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Edit Form -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200">
            <div class="px-6 py-4 border-b border-gray-200">
                <h2 class="text-lg font-semibold text-gray-900">Student Information</h2>
            </div>
            
            <form method="POST" enctype="multipart/form-data" class="p-6">
                {% csrf_token %}
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Personal Information -->
                    <div class="space-y-6">
                        <h3 class="text-lg font-medium text-gray-900 border-b pb-2">Personal Information</h3>
                        
                        <div>
                            <label for="first_name" class="block text-sm font-medium text-gray-700 mb-2">
                                First Name
                            </label>
                            <input type="text" 
                                   id="first_name" 
                                   name="first_name" 
                                   value="{{ student.first_name }}"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                   required>
                        </div>
                        
                        <div>
                            <label for="last_name" class="block text-sm font-medium text-gray-700 mb-2">
                                Last Name
                            </label>
                            <input type="text" 
                                   id="last_name" 
                                   name="last_name" 
                                   value="{{ student.last_name }}"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                   required>
                        </div>
                        
                        <div>
                            <label for="email" class="block text-sm font-medium text-gray-700 mb-2">
                                Email Address
                            </label>
                            <input type="email" 
                                   id="email" 
                                   name="email" 
                                   value="{{ student.email }}"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                   required>
                        </div>
                        
                        <div>
                            <label for="phone_number" class="block text-sm font-medium text-gray-700 mb-2">
                                Phone Number
                            </label>
                            <input type="tel" 
                                   id="phone_number" 
                                   name="phone_number" 
                                   value="{{ student.phone_number|default:'' }}"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                    
                    <!-- Academic Information -->
                    <div class="space-y-6">
                        <h3 class="text-lg font-medium text-gray-900 border-b pb-2">Academic Information</h3>
                        
                        <div>
                            <label for="university_id" class="block text-sm font-medium text-gray-700 mb-2">
                                University ID
                            </label>
                            <input type="text" 
                                   id="university_id" 
                                   name="university_id" 
                                   value="{{ student.username }}"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100"
                                   readonly>
                            <p class="text-xs text-gray-500 mt-1">University ID cannot be changed</p>
                        </div>
                        
                        <div>
                            <label for="program" class="block text-sm font-medium text-gray-700 mb-2">
                                Program
                            </label>
                            <select id="program" 
                                    name="program" 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="Computer Science" {% if student.major == 'Computer Science' %}selected{% endif %}>Computer Science</option>
                                <option value="Information Technology" {% if student.major == 'Information Technology' %}selected{% endif %}>Information Technology</option>
                                <option value="Software Engineering" {% if student.major == 'Software Engineering' %}selected{% endif %}>Software Engineering</option>
                                <option value="Data Science" {% if student.major == 'Data Science' %}selected{% endif %}>Data Science</option>
                                <option value="Cybersecurity" {% if student.major == 'Cybersecurity' %}selected{% endif %}>Cybersecurity</option>
                                <option value="Business Administration" {% if student.major == 'Business Administration' %}selected{% endif %}>Business Administration</option>
                                <option value="Engineering" {% if student.major == 'Engineering' %}selected{% endif %}>Engineering</option>
                                <option value="Mathematics" {% if student.major == 'Mathematics' %}selected{% endif %}>Mathematics</option>
                                <option value="Physics" {% if student.major == 'Physics' %}selected{% endif %}>Physics</option>
                                <option value="Other" {% if student.major == 'Other' %}selected{% endif %}>Other</option>
                            </select>
                        </div>
                        
                        <div>
                            <label for="year_of_study" class="block text-sm font-medium text-gray-700 mb-2">
                                Year of Study
                            </label>
                            <select id="year_of_study" 
                                    name="year_of_study" 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="1" {% if student.academic_level == '1' %}selected{% endif %}>1st Year</option>
                                <option value="2" {% if student.academic_level == '2' %}selected{% endif %}>2nd Year</option>
                                <option value="3" {% if student.academic_level == '3' %}selected{% endif %}>3rd Year</option>
                                <option value="4" {% if student.academic_level == '4' %}selected{% endif %}>4th Year</option>
                                <option value="Graduate" {% if student.academic_level == 'Graduate' %}selected{% endif %}>Graduate</option>
                            </select>
                        </div>
                        
                        <div>
                            <label for="date_joined" class="block text-sm font-medium text-gray-700 mb-2">
                                Date Joined
                            </label>
                            <input type="text" 
                                   id="date_joined" 
                                   name="date_joined" 
                                   value="{{ student.date_joined|date:'M d, Y' }}"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100"
                                   readonly>
                            <p class="text-xs text-gray-500 mt-1">Registration date cannot be changed</p>
                        </div>
                    </div>
                </div>
                
                <!-- Profile Picture Section -->
                <div class="mb-8">
                    <h3 class="text-lg font-medium text-gray-900 border-b pb-2 mb-6">Profile Picture</h3>
                    <div class="flex items-center space-x-6">
                        <!-- Current Profile Picture -->
                        <div class="flex-shrink-0">
                            {% if student.profile_picture %}
                                <img src="{{ student.profile_picture.url }}" alt="Current Profile Picture" 
                                     class="w-24 h-24 rounded-full object-cover border-4 border-gray-200">
                            {% else %}
                                <div class="w-24 h-24 rounded-full bg-gray-200 flex items-center justify-center border-4 border-gray-200">
                                    <i class="fas fa-user text-gray-400 text-2xl"></i>
                                </div>
                            {% endif %}
                        </div>
                        
                        <!-- Upload New Picture -->
                        <div class="flex-1">
                            <label for="profile_picture" class="block text-sm font-medium text-gray-700 mb-2">
                                Upload New Profile Picture
                            </label>
                            <div class="flex items-center space-x-4">
                                <div id="preview-container" class="hidden">
                                    <img id="image-preview" src="" alt="Preview" 
                                         class="w-20 h-20 rounded-full object-cover border-2 border-gray-300">
                                </div>
                                <div class="flex-1">
                                    <input type="file" id="profile_picture" name="profile_picture" accept="image/*"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    <p class="text-sm text-gray-500 mt-1">Accepted formats: JPG, PNG, GIF (Max 5MB)</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Form Actions -->
                <div class="mt-8 pt-6 border-t border-gray-200">
                    <div class="flex items-center justify-between">
                        <a href="{% url 'staff_panel:student_detail' student.id %}" 
                           class="inline-flex items-center px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                            <i class="fas fa-times mr-2"></i>
                            Cancel
                        </a>
                        
                        <div class="flex space-x-3">
                            <button type="button" 
                                    onclick="resetForm()" 
                                    class="inline-flex items-center px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                                <i class="fas fa-undo mr-2"></i>
                                Reset
                            </button>
                            
                            <button type="submit" 
                                    class="inline-flex items-center px-4 py-2 text-sm font-medium text-white bg-blue-600 border border-transparent rounded-lg hover:bg-blue-700 transition-colors">
                                <i class="fas fa-save mr-2"></i>
                                Save Changes
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- JavaScript -->
<script>
function resetForm() {
    if (confirm('Are you sure you want to reset all changes?')) {
        document.querySelector('form').reset();
    }
}

// Image preview functionality
document.getElementById('profile_picture').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('image-preview').src = e.target.result;
            document.getElementById('preview-container').classList.remove('hidden');
        };
        reader.readAsDataURL(file);
    } else {
        document.getElementById('preview-container').classList.add('hidden');
    }
});

// Form validation
document.querySelector('form').addEventListener('submit', function(e) {
    const firstName = document.getElementById('first_name').value.trim();
    const lastName = document.getElementById('last_name').value.trim();
    const email = document.getElementById('email').value.trim();
    
    if (!firstName || !lastName || !email) {
        e.preventDefault();
        alert('Please fill in all required fields.');
        return false;
    }
    
    // Email validation
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
        e.preventDefault();
        alert('Please enter a valid email address.');
        return false;
    }
});

// File size validation
document.getElementById('profile_picture').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file && file.size > 5 * 1024 * 1024) { // 5MB limit
        alert('File size must be less than 5MB');
        this.value = '';
        document.getElementById('preview-container').classList.add('hidden');
    }
});
</script>
{% endblock %}