{% extends 'base/base.html' %}
{% load static %}

{% block title %}تعديل الطالب - {{ student.get_full_name }} - لوحة الموظفين{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 py-8">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Header -->
        <div class="mb-8">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <a href="{% url 'staff_panel:student_detail' student.id %}" 
                       class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-arrow-left text-xl"></i>
                    </a>
                    <div>
                        <h1 class="text-3xl font-bold text-gray-900">تعديل الطالب</h1>
                        <p class="mt-2 text-gray-600">تحديث معلومات {{ student.get_full_name }}</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Edit Form -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200">
            <div class="px-6 py-4 border-b border-gray-200">
                <h2 class="text-lg font-semibold text-gray-900">معلومات الطالب</h2>
            </div>
            
            <form method="POST" enctype="multipart/form-data" class="p-6">
                {% csrf_token %}
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Personal Information -->
                    <div class="space-y-6">
                        <h3 class="text-lg font-medium text-gray-900 border-b pb-2">المعلومات الشخصية</h3>
                        
                        <div>
                            <label for="first_name" class="block text-sm font-medium text-gray-700 mb-2">
                                الاسم الأول
                            </label>
                            <input type="text" 
                                   id="first_name" 
                                   name="first_name" 
                                   value="{{ student.first_name }}"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                   required>
                        </div>
                        
                        <div>
                            <label for="last_name" class="block text-sm font-medium text-gray-700 mb-2">
                                اسم العائلة
                            </label>
                            <input type="text" 
                                   id="last_name" 
                                   name="last_name" 
                                   value="{{ student.last_name }}"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                   required>
                        </div>
                        
                        <div>
                            <label for="email" class="block text-sm font-medium text-gray-700 mb-2">
                                عنوان البريد الإلكتروني
                            </label>
                            <input type="email" 
                                   id="email" 
                                   name="email" 
                                   value="{{ student.email }}"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                   required>
                        </div>
                        
                        <div>
                            <label for="phone_number" class="block text-sm font-medium text-gray-700 mb-2">
                                رقم الهاتف
                            </label>
                            <input type="tel" 
                                   id="phone_number" 
                                   name="phone_number" 
                                   value="{{ student.phone_number|default:'' }}"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                    
                    <!-- Academic Information -->
                    <div class="space-y-6">
                        <h3 class="text-lg font-medium text-gray-900 border-b pb-2">المعلومات الأكاديمية</h3>
                        
                        <div>
                            <label for="university_id" class="block text-sm font-medium text-gray-700 mb-2">
                                الرقم الجامعي
                            </label>
                            <input type="text" 
                                   id="university_id" 
                                   name="university_id" 
                                   value="{{ student.username }}"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100"
                                   readonly>
                            <p class="text-xs text-gray-500 mt-1">لا يمكن تغيير الرقم الجامعي</p>
                        </div>
                        
                        <div>
                            <label for="program" class="block text-sm font-medium text-gray-700 mb-2">
                                البرنامج
                            </label>
                            <select id="program" 
                                    name="program" 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="Computer Science" {% if student.major == 'Computer Science' %}selected{% endif %}>علوم الحاسوب</option>
                                <option value="Information Technology" {% if student.major == 'Information Technology' %}selected{% endif %}>تكنولوجيا المعلومات</option>
                                <option value="Software Engineering" {% if student.major == 'Software Engineering' %}selected{% endif %}>هندسة البرمجيات</option>
                                <option value="Data Science" {% if student.major == 'Data Science' %}selected{% endif %}>علوم البيانات</option>
                                <option value="Cybersecurity" {% if student.major == 'Cybersecurity' %}selected{% endif %}>الأمن السيبراني</option>
                                <option value="Business Administration" {% if student.major == 'Business Administration' %}selected{% endif %}>إدارة الأعمال</option>
                                <option value="Engineering" {% if student.major == 'Engineering' %}selected{% endif %}>الهندسة</option>
                                <option value="Mathematics" {% if student.major == 'Mathematics' %}selected{% endif %}>الرياضيات</option>
                                <option value="Physics" {% if student.major == 'Physics' %}selected{% endif %}>الفيزياء</option>
                                <option value="Other" {% if student.major == 'Other' %}selected{% endif %}>أخرى</option>
                            </select>
                        </div>
                        
                        <div>
                            <label for="year_of_study" class="block text-sm font-medium text-gray-700 mb-2">
                                سنة الدراسة
                            </label>
                            <select id="year_of_study" 
                                    name="year_of_study" 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="1" {% if student.academic_level == '1' %}selected{% endif %}>السنة الأولى</option>
                                <option value="2" {% if student.academic_level == '2' %}selected{% endif %}>السنة الثانية</option>
                                <option value="3" {% if student.academic_level == '3' %}selected{% endif %}>السنة الثالثة</option>
                                <option value="4" {% if student.academic_level == '4' %}selected{% endif %}>السنة الرابعة</option>
                                <option value="Graduate" {% if student.academic_level == 'Graduate' %}selected{% endif %}>خريج</option>
                            </select>
                        </div>
                        
                        <div>
                            <label for="date_joined" class="block text-sm font-medium text-gray-700 mb-2">
                                تاريخ الانضمام
                            </label>
                            <input type="text" 
                                   id="date_joined" 
                                   name="date_joined" 
                                   value="{{ student.date_joined|date:'M d, Y' }}"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100"
                                   readonly>
                            <p class="text-xs text-gray-500 mt-1">لا يمكن تغيير تاريخ التسجيل</p>
                        </div>
                    </div>
                </div>
                
                <!-- Profile Picture Section -->
                <div class="mb-8">
                    <h3 class="text-lg font-medium text-gray-900 border-b pb-2 mb-6">صورة الملف الشخصي</h3>
                    <div class="flex items-center space-x-6">
                        <!-- Current Profile Picture -->
                        <div class="flex-shrink-0">
                            {% if student.profile_picture %}
                                <img src="{{ student.profile_picture.url }}" alt="صورة الملف الشخصي الحالية" 
                                     class="w-24 h-24 rounded-full object-cover border-4 border-gray-200">
                            {% else %}
                                <div class="w-24 h-24 rounded-full bg-gray-200 flex items-center justify-center border-4 border-gray-200">
                                    <i class="fas fa-user text-gray-400 text-2xl"></i>
                                </div>
                            {% endif %}
                        </div>
                        
                        <!-- Upload New Picture -->
                        <div class="flex-1">
                            <label for="profile_picture" class="block text-sm font-medium text-gray-700 mb-2">
                                رفع صورة ملف شخصي جديدة
                            </label>
                            <div class="flex items-center space-x-4">
                                <div id="preview-container" class="hidden">
                                    <img id="image-preview" src="" alt="معاينة" 
                                         class="w-20 h-20 rounded-full object-cover border-2 border-gray-300">
                                </div>
                                <div class="flex-1">
                                    <input type="file" id="profile_picture" name="profile_picture" accept="image/*"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    <p class="text-sm text-gray-500 mt-1">الصيغ المقبولة: JPG, PNG, GIF (حد أقصى 5 ميجابايت)</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Form Actions -->
                <div class="mt-8 pt-6 border-t border-gray-200">
                    <div class="flex items-center justify-between">
                        <a href="{% url 'staff_panel:student_detail' student.id %}" 
                           class="inline-flex items-center px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                            <i class="fas fa-times mr-2"></i>
                            إلغاء
                        </a>
                        
                        <div class="flex space-x-3">
                            <button type="button" 
                                    onclick="resetForm()" 
                                    class="inline-flex items-center px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                                <i class="fas fa-undo mr-2"></i>
                                إعادة تعيين
                            </button>
                            
                            <button type="submit" 
                                    class="inline-flex items-center px-4 py-2 text-sm font-medium text-white bg-blue-600 border border-transparent rounded-lg hover:bg-blue-700 transition-colors">
                                <i class="fas fa-save mr-2"></i>
                                حفظ التغييرات
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- JavaScript -->
<script>
function resetForm() {
    if (confirm('هل أنت متأكد من أنك تريد إعادة تعيين جميع التغييرات؟')) {
        document.querySelector('form').reset();
    }
}

// Image preview functionality
document.getElementById('profile_picture').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('image-preview').src = e.target.result;
            document.getElementById('preview-container').classList.remove('hidden');
        };
        reader.readAsDataURL(file);
    } else {
        document.getElementById('preview-container').classList.add('hidden');
    }
});

// Form validation
document.querySelector('form').addEventListener('submit', function(e) {
    const firstName = document.getElementById('first_name').value.trim();
    const lastName = document.getElementById('last_name').value.trim();
    const email = document.getElementById('email').value.trim();
    
    if (!firstName || !lastName || !email) {
        e.preventDefault();
        alert('يرجى ملء جميع الحقول المطلوبة.');
        return false;
    }
    
    // Email validation
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
        e.preventDefault();
        alert('يرجى إدخال عنوان بريد إلكتروني صحيح.');
        return false;
    }
});

// File size validation
document.getElementById('profile_picture').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file && file.size > 5 * 1024 * 1024) { // 5MB limit
        alert('يجب أن يكون حجم الملف أقل من 5 ميجابايت');
        this.value = '';
        document.getElementById('preview-container').classList.add('hidden');
    }
});
</script>
{% endblock %}