{% extends 'base/base.html' %}
{% load static %}

{% block title %}تغيير كلمة المرور - خدمات الجامعة{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 py-8">
    <div class="max-w-2xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Header -->
        <div class="mb-8">
            <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-900">
                            <i class="fas fa-key ml-3" style="color: #102A71;"></i>
                            تغيير كلمة المرور
                        </h1>
                        <p class="text-gray-600 mt-2">تحديث كلمة مرور حسابك لأمان أفضل</p>
                    </div>
                    <a href="{% url 'accounts:profile' %}" class="inline-flex items-center px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors">
                        <i class="fas fa-arrow-right ml-2"></i>
                        العودة للملف الشخصي
                    </a>
                </div>
            </div>
        </div>
        
        <!-- Password Change Form -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100">
            <div class="p-6">
                <!-- Security Tips -->
                <div class="mb-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
                    <h3 class="text-sm font-semibold text-blue-900 mb-2">
                        <i class="fas fa-shield-alt ml-2"></i>
                        نصائح أمان كلمة المرور
                    </h3>
                    <ul class="text-sm text-blue-800 space-y-1">
                        <li>• استخدم 8 أحرف على الأقل مع مزيج من الحروف والأرقام والرموز</li>
                        <li>• تجنب استخدام المعلومات الشخصية مثل اسمك أو تاريخ ميلادك</li>
                        <li>• لا تعيد استخدام كلمات المرور من حسابات أخرى</li>
                        <li>• فكر في استخدام مدير كلمات المرور لأمان أفضل</li>
                    </ul>
                </div>
                
                <form method="post" class="space-y-6">
                    {% csrf_token %}
                    
                    <!-- Current Password -->
                    <div>
                        <label for="{{ form.old_password.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-lock ml-1"></i>
                            كلمة المرور الحالية
                        </label>
                        <div class="relative">
                            {{ form.old_password }}
                            <button type="button" class="absolute inset-y-0 right-0 pr-3 flex items-center" onclick="togglePassword('{{ form.old_password.id_for_label }}')"
                                    id="toggle-old-password">
                                <i class="fas fa-eye text-gray-400 hover:text-gray-600"></i>
                            </button>
                        </div>
                        {% if form.old_password.errors %}
                            <div class="mt-1 text-sm text-red-600">
                                {% for error in form.old_password.errors %}
                                    <p><i class="fas fa-exclamation-circle ml-1"></i>{{ error }}</p>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <!-- New Password -->
                    <div>
                        <label for="{{ form.new_password1.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-key ml-1"></i>
                            كلمة المرور الجديدة
                        </label>
                        <div class="relative">
                            {{ form.new_password1 }}
                            <button type="button" class="absolute inset-y-0 right-0 pr-3 flex items-center" onclick="togglePassword('{{ form.new_password1.id_for_label }}')"
                                    id="toggle-new-password1">
                                <i class="fas fa-eye text-gray-400 hover:text-gray-600"></i>
                            </button>
                        </div>
                        {% if form.new_password1.errors %}
                            <div class="mt-1 text-sm text-red-600">
                                {% for error in form.new_password1.errors %}
                                    <p><i class="fas fa-exclamation-circle ml-1"></i>{{ error }}</p>
                                {% endfor %}
                            </div>
                        {% endif %}
                        <!-- Password Strength Indicator -->
                        <div class="mt-2">
                            <div class="flex items-center space-x-2">
                                <div class="flex-1">
                                    <div class="w-full bg-gray-200 rounded-full h-2">
                                        <div id="password-strength-bar" class="h-2 rounded-full transition-all duration-300" style="width: 0%; background-color: #ef4444;"></div>
                                    </div>
                                </div>
                                <span id="password-strength-text" class="text-xs text-gray-500">ضعيفة</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Confirm New Password -->
                    <div>
                        <label for="{{ form.new_password2.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-check-double ml-1"></i>
                            تأكيد كلمة المرور الجديدة
                        </label>
                        <div class="relative">
                            {{ form.new_password2 }}
                            <button type="button" class="absolute inset-y-0 right-0 pr-3 flex items-center" onclick="togglePassword('{{ form.new_password2.id_for_label }}')"
                                    id="toggle-new-password2">
                                <i class="fas fa-eye text-gray-400 hover:text-gray-600"></i>
                            </button>
                        </div>
                        {% if form.new_password2.errors %}
                            <div class="mt-1 text-sm text-red-600">
                                {% for error in form.new_password2.errors %}
                                    <p><i class="fas fa-exclamation-circle mr-1"></i>{{ error }}</p>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <!-- Form Actions -->
                    <div class="flex items-center justify-between pt-6 border-t border-gray-200">
                        <a href="{% url 'accounts:profile' %}" class="inline-flex items-center px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors">
                            <i class="fas fa-times ml-2"></i>
                            إلغاء
                        </a>
                        <button type="submit" class="inline-flex items-center px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                            <i class="fas fa-save ml-2"></i>
                            تغيير كلمة المرور
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Additional Security Options -->
        <div class="mt-8 bg-white rounded-xl shadow-sm border border-gray-100">
            <div class="p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">
                    <i class="fas fa-shield-alt ml-2" style="color: #102A71;"></i>
                    الأمان الإضافي
                </h3>
                
                <div class="space-y-4">
                    <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                        <div>
                            <h4 class="text-sm font-medium text-gray-900">المصادقة الثنائية</h4>
                            <p class="text-sm text-gray-500">أضف طبقة حماية إضافية لحسابك</p>
                        </div>
                        <button class="inline-flex items-center px-3 py-1 text-sm bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition-colors">
                            <i class="fas fa-mobile-alt ml-1"></i>
                            تفعيل
                        </button>
                    </div>
                    
                    <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                        <div>
                            <h4 class="text-sm font-medium text-gray-900">إشعارات تسجيل الدخول</h4>
                            <p class="text-sm text-gray-500">احصل على إشعار عند دخول أي شخص لحسابك</p>
                        </div>
                        <button class="inline-flex items-center px-3 py-1 text-sm bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition-colors">
                            <i class="fas fa-bell ml-1"></i>
                            إعداد
                        </button>
                    </div>
                    
                    <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                        <div>
                            <h4 class="text-sm font-medium text-gray-900">الجلسات النشطة</h4>
                            <p class="text-sm text-gray-500">عرض وإدارة جلسات تسجيل الدخول النشطة</p>
                        </div>
                        <button class="inline-flex items-center px-3 py-1 text-sm bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors">
                            <i class="fas fa-list ml-1"></i>
                            عرض
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function togglePassword(fieldId) {
    const field = document.getElementById(fieldId);
    const toggleBtn = document.getElementById('toggle-' + fieldId.replace('id_', ''));
    const icon = toggleBtn.querySelector('i');
    
    if (field.type === 'password') {
        field.type = 'text';
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
    } else {
        field.type = 'password';
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
    }
}

// Password strength checker
document.addEventListener('DOMContentLoaded', function() {
    const passwordField = document.getElementById('{{ form.new_password1.id_for_label }}');
    const strengthBar = document.getElementById('password-strength-bar');
    const strengthText = document.getElementById('password-strength-text');
    
    if (passwordField) {
        passwordField.addEventListener('input', function() {
            const password = this.value;
            const strength = calculatePasswordStrength(password);
            
            // Update strength bar
            strengthBar.style.width = strength.percentage + '%';
            strengthBar.style.backgroundColor = strength.color;
            strengthText.textContent = strength.text;
        });
    }
});

function calculatePasswordStrength(password) {
    let score = 0;
    
    // Length check
    if (password.length >= 8) score += 25;
    if (password.length >= 12) score += 25;
    
    // Character variety checks
    if (/[a-z]/.test(password)) score += 10;
    if (/[A-Z]/.test(password)) score += 10;
    if (/[0-9]/.test(password)) score += 15;
    if (/[^A-Za-z0-9]/.test(password)) score += 15;
    
    // Determine strength level
    if (score < 30) {
        return { percentage: score, color: '#ef4444', text: 'ضعيفة' };
    } else if (score < 60) {
        return { percentage: score, color: '#f59e0b', text: 'مقبولة' };
    } else if (score < 80) {
        return { percentage: score, color: '#3b82f6', text: 'جيدة' };
    } else {
        return { percentage: score, color: '#10b981', text: 'قوية' };
    }
}
</script>

<style>
/* Form styling */
#{{ form.old_password.id_for_label }},
#{{ form.new_password1.id_for_label }},
#{{ form.new_password2.id_for_label }} {
    width: 100%;
    padding: 0.75rem 2.5rem 0.75rem 0.75rem;
    border: 1px solid #d1d5db;
    border-radius: 0.5rem;
    font-size: 0.875rem;
    transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
}

#{{ form.old_password.id_for_label }}:focus,
#{{ form.new_password1.id_for_label }}:focus,
#{{ form.new_password2.id_for_label }}:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}
</style>
{% endblock %}