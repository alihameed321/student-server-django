{% extends 'base/base.html' %}
{% load static %}

{% block title %}دفع الرسوم - خدمات الجامعة{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 py-8">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Header -->
        <div class="mb-8">
            <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-900">
                            <i class="fas fa-credit-card ml-3" style="color: #102A71;"></i>
                            دفع الرسوم
                        </h1>
                        <p class="text-gray-600 mt-2">دفع آمن عبر الإنترنت لرسومك الجامعية</p>
                    </div>
                    <a href="{% url 'financial:dashboard' %}" class="inline-flex items-center px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors">
                        <i class="fas fa-arrow-left mr-2"></i>
                        العودة للوحة التحكم
                    </a>
                </div>
            </div>
        </div>
        
        <!-- Outstanding Fees Summary -->
        <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100 mb-8">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">
                <i class="fas fa-file-invoice-dollar mr-2" style="color: #F5C400;"></i>
                الرسوم المستحقة
            </h2>
            
            {% if has_outstanding_fees %}
                <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
                    <div class="flex items-center">
                        <i class="fas fa-exclamation-triangle text-red-600 mr-2"></i>
                        <span class="text-red-800 font-medium">إجمالي المستحق: ${{ outstanding_fees|floatformat:2 }}</span>
                    </div>
                </div>
            {% else %}
                <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
                    <div class="flex items-center">
                        <i class="fas fa-check-circle text-green-600 mr-2"></i>
                        <span class="text-green-800 font-medium">لا توجد رسوم مستحقة</span>
                    </div>
                </div>
            {% endif %}
            
            <!-- Fee Breakdown - Display Only -->
            {% if fee_breakdown %}
            <div class="space-y-3">
                {% for fee in fee_breakdown %}
                <div class="flex justify-between items-center py-3 border-b border-gray-200">
                    <div class="flex items-center">
                        <div class="mr-3 w-4 h-4 bg-blue-100 rounded border border-blue-300 flex items-center justify-center">
                            <i class="fas fa-dollar-sign text-blue-600 text-xs"></i>
                        </div>
                        <div>
                            <span class="text-gray-900 font-medium">{{ fee.name }}</span>
                            {% if fee.is_overdue %}
                                <span class="ml-2 inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-red-100 text-red-800">
                                    <i class="fas fa-exclamation-triangle ml-1"></i> متأخر
                                </span>
                            {% endif %}
                            <div class="text-sm text-gray-500">الاستحقاق: {{ fee.due_date|date:"M d, Y" }}</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="font-semibold text-gray-900">${{ fee.amount|floatformat:2 }}</div>
                        <div class="text-sm text-green-600">المدفوع: ${{ fee.paid|floatformat:2 }}</div>
                        <div class="text-sm font-medium {% if fee.remaining > 0 %}text-red-600{% else %}text-green-600{% endif %}">
                            المتبقي: ${{ fee.remaining|floatformat:2 }}
                        </div>
                    </div>
                </div>
                {% endfor %}
                
                <div class="flex justify-between items-center py-3 bg-gray-50 px-4 rounded-lg">
                    <span class="text-lg font-semibold text-gray-900">إجمالي المستحق</span>
                    <span class="text-lg font-bold" style="color: #102A71;">${{ outstanding_fees|floatformat:2 }}</span>
                </div>
            </div>
            {% else %}
            <div class="text-center py-8">
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
                    <i class="fas fa-check-circle text-blue-600 text-3xl mb-3"></i>
                    <h3 class="text-lg font-semibold text-blue-900 mb-2">لا توجد رسوم مستحقة</h3>
                    <p class="text-blue-700">ليس لديك حالياً أي رسوم مستحقة للدفع. جميع رسومك محدثة!</p>
                    <a href="{% url 'financial:dashboard' %}" class="inline-flex items-center mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                        <i class="fas fa-arrow-left ml-2"></i>
                        العودة للوحة التحكم المالية
                    </a>
                </div>
            </div>
            {% endif %}
        </div>
        
        <!-- Payment Form -->
        {% if fee_breakdown %}
        <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
            <h2 class="text-xl font-semibold text-gray-900 mb-6">
                <i class="fas fa-lock ml-2" style="color: #102A71;"></i>
                الدفع الآمن
            </h2>
            
            <form method="post" class="space-y-6">
                {% csrf_token %}
                
                <!-- Fee Selection -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-3">اختر الرسوم للدفع</label>
                    <div class="space-y-3 max-h-60 overflow-y-auto border border-gray-200 rounded-lg p-4">
                        {% for fee in fee_breakdown %}
                        <div class="flex justify-between items-center py-2 border-b border-gray-100 last:border-b-0">
                            <div class="flex items-center">
                                <input type="checkbox" name="selected_fees" value="{{ fee.id }}" class="mr-3 fee-checkbox" data-amount="{{ fee.remaining }}" id="fee_{{ fee.id }}">
                                <label for="fee_{{ fee.id }}" class="cursor-pointer">
                                    <span class="text-gray-900 font-medium">{{ fee.name }}</span>
                                    {% if fee.is_overdue %}
                                        <span class="ml-2 inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-red-100 text-red-800">
                                            <i class="fas fa-exclamation-triangle mr-1"></i> Overdue
                                        </span>
                                    {% endif %}
                                    <div class="text-sm text-gray-500">Due: {{ fee.due_date|date:"M d, Y" }}</div>
                                </label>
                            </div>
                            <div class="text-right">
                                <div class="text-sm font-medium {% if fee.remaining > 0 %}text-red-600{% else %}text-green-600{% endif %}">
                                    ${{ fee.remaining|floatformat:2 }}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    <div class="flex justify-between items-center mt-2">
                        <p class="text-sm text-gray-500">Select the fees you want to pay</p>
                        <button type="button" id="select-all-fees" class="text-sm text-blue-600 hover:text-blue-800">اختر جميع الرسوم</button>
                    </div>
                </div>
                
                <!-- Payment Amount -->
                <div>
                    <label for="amount" class="block text-sm font-medium text-gray-700 mb-2">مبلغ الدفع</label>
                    <div class="relative">
                        <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">$</span>
                        <input type="number" id="amount" name="amount" step="0.01" min="0" max="{{ outstanding_fees }}" value="{{ outstanding_fees|floatformat:2 }}" 
                               class="w-full pl-8 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div class="mt-2">
                        <p class="text-sm text-gray-500">يمكنك دفع المبلغ كاملاً أو دفع جزئي</p>
                    </div>
                </div>
                
                <!-- Transaction Reference -->
                <div>
                    <label for="transaction_reference" class="block text-sm font-medium text-gray-700 mb-2">مرجع المعاملة (اختياري)</label>
                    <input type="text" id="transaction_reference" name="transaction_reference" placeholder="أدخل مرجع المعاملة" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <p class="text-sm text-gray-500 mt-1">إذا كان لديك رقم مرجعي من البنك أو مقدم خدمة الدفع</p>
                </div>
                
                <!-- Payment Method -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-3">اختر مقدم خدمة الدفع</label>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {% for provider in payment_providers %}
                        <div class="provider-card border border-gray-300 rounded-lg overflow-hidden hover:shadow-md transition-shadow">
                            <label class="block cursor-pointer">
                                <input type="radio" name="payment_method" value="{{ provider.id }}" class="sr-only provider-radio" {% if forloop.first %}checked{% endif %}>
                                <div class="provider-content p-4 border-2 border-transparent hover:border-blue-200 transition-colors">
                                    <!-- Provider Header -->
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center">
                                            {% if provider.logo %}
                                                <img src="{{ provider.logo.url }}" alt="{{ provider.name }}" class="w-12 h-12 object-contain mr-3">
                                            {% else %}
                                                {% if 'credit' in provider.name.lower or 'card' in provider.name.lower %}
                                                    <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center mr-3">
                                                        <i class="fas fa-credit-card text-blue-600 text-xl"></i>
                                                    </div>
                                                {% elif 'bank' in provider.name.lower or 'transfer' in provider.name.lower %}
                                                    <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center mr-3">
                                                        <i class="fas fa-university text-green-600 text-xl"></i>
                                                    </div>
                                                {% elif 'online' in provider.name.lower %}
                                                    <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center mr-3">
                                                        <i class="fas fa-laptop text-purple-600 text-xl"></i>
                                                    </div>
                                                {% else %}
                                                    <div class="w-12 h-12 bg-gray-100 rounded-lg flex items-center justify-center mr-3">
                                                        <i class="fas fa-money-bill text-gray-600 text-xl"></i>
                                                    </div>
                                                {% endif %}
                                            {% endif %}
                                            <div>
                                                <h3 class="font-semibold text-gray-900">{{ provider.name }}</h3>
                                            </div>
                                        </div>
                                        
                                        <!-- University Account Number -->
                                        {% if provider.university_account_number %}
                                        <div class="text-right">
                                            <p class="text-sm text-gray-600">رقم الحساب</p>
                                            <p class="font-medium text-gray-900">{{ provider.university_account_number }}</p>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </label>
                        </div>
                        {% empty %}
                        <div class="col-span-2">
                            <p class="text-gray-500 text-center py-8">لا توجد طرق دفع متاحة</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                
                <!-- Transfer Details -->
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">
                        <i class="fas fa-user ml-2 text-yellow-600"></i>
                        تفاصيل التحويل
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="sender_name" class="block text-sm font-medium text-gray-700 mb-2">اسم المرسل (اختياري)</label>
                            <input type="text" id="sender_name" name="sender_name" 
                                   placeholder="اسم الشخص الذي أرسل المال" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <p class="text-xs text-gray-500 mt-1">أدخل اسم الشخص الذي قام بالتحويل</p>
                        </div>
                        <div>
                            <label for="sender_phone" class="block text-sm font-medium text-gray-700 mb-2">هاتف المرسل (اختياري)</label>
                            <input type="tel" id="sender_phone" name="sender_phone" 
                                   placeholder="رقم هاتف المرسل" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <p class="text-xs text-gray-500 mt-1">رقم الهاتف لأغراض التحقق</p>
                        </div>
                    </div>
                    <div class="mt-4">
                        <label for="transfer_notes" class="block text-sm font-medium text-gray-700 mb-2">ملاحظات إضافية (اختياري)</label>
                        <textarea id="transfer_notes" name="transfer_notes" rows="3" 
                                  placeholder="أي معلومات إضافية حول التحويل..." 
                                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                        <p class="text-xs text-gray-500 mt-1">أدرج أي تفاصيل ذات صلة بدفعتك</p>
                    </div>
                </div>
                
                <!-- Card Details (shown when credit card is selected) -->
                <div id="card-details" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="card_number" class="block text-sm font-medium text-gray-700 mb-2">رقم البطاقة</label>
                            <input type="text" id="card_number" name="card_number" placeholder="1234 5678 9012 3456" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div>
                            <label for="card_name" class="block text-sm font-medium text-gray-700 mb-2">اسم حامل البطاقة</label>
                            <input type="text" id="card_name" name="card_name" placeholder="John Doe" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="expiry" class="block text-sm font-medium text-gray-700 mb-2">تاريخ الانتهاء</label>
                            <input type="text" id="expiry" name="expiry" placeholder="MM/YY" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div>
                            <label for="cvv" class="block text-sm font-medium text-gray-700 mb-2">رمز الأمان</label>
                            <input type="text" id="cvv" name="cvv" placeholder="123" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                    </div>
                </div>
                
                <!-- Security Notice -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <div class="flex items-start">
                        <i class="fas fa-shield-alt text-blue-600 mr-3 mt-1"></i>
                        <div>
                            <h3 class="text-sm font-medium text-blue-800">الدفع الآمن</h3>
                            <p class="text-sm text-blue-700 mt-1">
                                معلومات الدفع الخاصة بك مشفرة وآمنة. نحن نستخدم تشفير SSL المعياري في الصناعة لحماية بياناتك.
                            </p>
                        </div>
                    </div>
                </div>
                
                <!-- Submit Button -->
                <div class="flex justify-end space-x-4">
                    <a href="{% url 'financial:dashboard' %}" class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                        إلغاء
                    </a>
                    <button type="submit" class="px-8 py-3 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-lg hover:from-blue-700 hover:to-blue-800 transition-all duration-200">
                        <i class="fas fa-lock ml-2"></i>
                        ادفع بأمان
                    </button>
                </div>
            </form>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .provider-card.selected .provider-content {
        border-color: #3B82F6 !important;
        background-color: #EFF6FF;
    }
    
    .provider-card.selected {
        box-shadow: 0 0 0 2px #3B82F6;
    }
    
    .provider-radio:checked + .provider-content {
        border-color: #3B82F6 !important;
        background-color: #EFF6FF;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Add immediate debug logging
        console.log('=== Page Loaded Debug ===');
        console.log('DOMContentLoaded event fired');
        
        const amountInput = document.getElementById('amount');
        const feeCheckboxes = document.querySelectorAll('.fee-checkbox');
        const selectAllBtn = document.getElementById('select-all-fees');
        const providerRadios = document.querySelectorAll('.provider-radio');
        const providerCards = document.querySelectorAll('.provider-card');
        
        console.log('Elements found:');
        console.log('- Amount input:', amountInput ? 'Found' : 'Not found');
        console.log('- Fee checkboxes:', feeCheckboxes.length);
        console.log('- Provider radios:', providerRadios.length);
        console.log('- Provider cards:', providerCards.length);
        
        // Handle provider selection visual feedback
        function updateProviderSelection() {
            providerCards.forEach(card => {
                const radio = card.querySelector('.provider-radio');
                if (radio.checked) {
                    card.classList.add('selected');
                } else {
                    card.classList.remove('selected');
                }
            });
        }
        
        // Add click handlers to provider cards
        providerCards.forEach(card => {
            card.addEventListener('click', function() {
                const radio = this.querySelector('.provider-radio');
                radio.checked = true;
                updateProviderSelection();
                
                // Trigger change event for card details visibility
                radio.dispatchEvent(new Event('change'));
            });
        });
        
        // Show/hide card details based on payment method
        providerRadios.forEach(radio => {
            radio.addEventListener('change', function() {
                const cardDetails = document.getElementById('card-details');
                const providerCard = this.closest('.provider-card');
                const providerName = providerCard.querySelector('h3').textContent.toLowerCase();
                
                if (providerName.includes('credit') || providerName.includes('card')) {
                    cardDetails.style.display = 'block';
                } else {
                    cardDetails.style.display = 'none';
                }
                
                updateProviderSelection();
            });
        });
        
        // Initialize provider selection and card details visibility on page load
        updateProviderSelection();
        const checkedRadio = document.querySelector('.provider-radio:checked');
        if (checkedRadio) {
            const cardDetails = document.getElementById('card-details');
            const providerCard = checkedRadio.closest('.provider-card');
            const providerName = providerCard.querySelector('h3').textContent.toLowerCase();
            
            if (providerName.includes('credit') || providerName.includes('card')) {
                cardDetails.style.display = 'block';
            } else {
                cardDetails.style.display = 'none';
            }
        }
        
        // Handle fee selection and amount calculation
        function updatePaymentAmount() {
            let totalSelected = 0;
            feeCheckboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    totalSelected += parseFloat(checkbox.dataset.amount) || 0;
                }
            });
            
            if (totalSelected > 0) {
                amountInput.value = totalSelected.toFixed(2);
                amountInput.max = totalSelected;
            } else {
                amountInput.value = '{{ outstanding_fees|floatformat:2 }}';
                amountInput.max = '{{ outstanding_fees }}';
            }
        }
        
        // Add event listeners to fee checkboxes (only if they exist)
        if (feeCheckboxes.length > 0) {
            feeCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', updatePaymentAmount);
            });
            
            // Select all fees button
            if (selectAllBtn) {
                selectAllBtn.addEventListener('click', function() {
                    const allChecked = Array.from(feeCheckboxes).every(cb => cb.checked);
                    
                    feeCheckboxes.forEach(checkbox => {
                        checkbox.checked = !allChecked;
                    });
                    
                    updatePaymentAmount();
                    this.textContent = allChecked ? 'Select All Fees' : 'Deselect All';
                });
            }
        }
        
        // Form validation - target the payment form specifically
        const form = document.querySelector('form[method="post"]');
        let submitButton = null;
        if (form) {
            // Find all submit buttons in the form and check their text
            const submitButtons = form.querySelectorAll('button[type="submit"]');
            for (const button of submitButtons) {
                if (button.textContent.trim().includes('Pay Securely')) {
                    submitButton = button;
                    break;
                }
            }
            // Fallback to any submit button in the form if "Pay Securely" not found
            if (!submitButton && submitButtons.length > 0) {
                submitButton = submitButtons[0];
            }
        }
        console.log('Form element found:', form ? 'YES' : 'NO');
        console.log('Submit button found:', submitButton ? 'YES' : 'NO');
        console.log('Submit button element:', submitButton);
        console.log('Submit button type:', submitButton ? submitButton.type : 'N/A');
        console.log('Submit button text:', submitButton ? submitButton.textContent.trim() : 'N/A');
        
        // Add click listener to submit button for debugging (using capture phase)
        if (submitButton) {
            console.log('Attaching click event listener to submit button');
            submitButton.addEventListener('click', function(e) {
                console.log('=== SUBMIT BUTTON CLICKED ===');
                console.log('Event object:', e);
                console.log('Event target:', e.target);
                // Prevent default form submission to force our validation
                e.preventDefault();
                e.stopPropagation();
                e.stopImmediatePropagation();
                
                // Manually trigger form validation
                const formEvent = new Event('submit', { cancelable: true });
                form.dispatchEvent(formEvent);
            }, true); // Use capture phase
            console.log('Click event listener attached successfully');
        } else {
            console.log('ERROR: Submit button not found, cannot attach click listener');
        }
        
        if (form) {
            console.log('Adding submit event listener to form');
            form.addEventListener('submit', function(e) {
                console.log('=== FORM SUBMIT EVENT TRIGGERED ===');
                const amount = parseFloat(amountInput.value);
                const maxAmount = parseFloat(amountInput.max);
                
                // Re-query fee checkboxes to ensure we have the current state
                const currentFeeCheckboxes = document.querySelectorAll('.fee-checkbox');
                
                // Debug: Print selected fees information
                console.log('=== Payment Form Debug Info ===');
                console.log('Total fee checkboxes found:', currentFeeCheckboxes.length);
                
                if (currentFeeCheckboxes.length > 0) {
                    const selectedFees = Array.from(currentFeeCheckboxes).filter(cb => cb.checked);
                    console.log('Selected fees count:', selectedFees.length);
                    console.log('Selected fee IDs:', selectedFees.map(cb => cb.value));
                    console.log('Selected fee amounts:', selectedFees.map(cb => cb.dataset.amount));
                    
                    // Alert with selected fees info for user visibility
                    if (selectedFees.length > 0) {
                        const feeInfo = selectedFees.map(cb => `Fee ID: ${cb.value}, Amount: $${cb.dataset.amount}`).join('\n');
                        alert(`Selected Fees:\n${feeInfo}\n\nTotal Amount: $${amount}`);
                    }
                    
                    if (selectedFees.length === 0) {
                        e.preventDefault();
                        alert('Please select at least one fee to pay.');
                        return;
                    }
                } else {
                    console.log('No fee checkboxes found - allowing payment without fee selection');
                    alert(`Payment without specific fees selected.\nAmount: $${amount}`);
                }
                
                if (amount <= 0) {
                    e.preventDefault();
                    alert('Please enter a valid payment amount.');
                    return;
                }
                
                if (amount > maxAmount) {
                    e.preventDefault();
                    alert('Payment amount cannot exceed the outstanding balance.');
                    return;
                }
                
                // Show loading state
                const submitBtn = form.querySelector('button[type="submit"]');
                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Processing...';
                }
            });
        }
    });
</script>
{% endblock %}